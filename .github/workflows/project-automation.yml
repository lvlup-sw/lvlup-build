name: Project Automation

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened]
  pull_request:
    types: [opened, ready_for_review, closed]
  push:
    branches: [main]
    paths:
      - '.github/labels.yml'
    tags:
      - 'v*'
  schedule:
    - cron: '0 9 * * 1'  # Weekly stale check, Monday 9am UTC

env:
  PROJECT_NUMBER: 3  # lvlup-sw org project

jobs:
  # ============================================================
  # LABEL SYNC: Sync labels from labels.yml on push
  # ============================================================
  label-sync:
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    uses: lvlup-sw/.github/.github/workflows/label-sync.yml@main
    secrets: inherit

  # ============================================================
  # AUTO-TRIAGE: Label new issues based on content
  # ============================================================
  auto-triage:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Auto-label based on title/body
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const text = `${issue.title} ${issue.body}`.toLowerCase();
            const labels = ['status:triage'];

            // Type detection
            if (text.match(/bug|error|fail|broken|crash|issue/)) {
              labels.push('type:bug');
            } else if (text.match(/feature|add|implement|support|enhance/)) {
              labels.push('type:feature');
            } else if (text.match(/doc|readme|typo|clarif/)) {
              labels.push('type:docs');
            } else if (text.match(/\?|how|what|why|question/)) {
              labels.push('type:question');
            }

            // Scope detection for Lvlup.Build
            if (text.match(/analyzer|stylecop|roslyn|diagnostic/)) {
              labels.push('scope:analyzers');
            }
            if (text.match(/props|targets|msbuild|build property|override/)) {
              labels.push('scope:props');
            }
            if (text.match(/stylecop\.json|sa\d{4}|documentation rule/)) {
              labels.push('scope:stylecop');
            }
            if (text.match(/globalconfig|severity|format.*rule/)) {
              labels.push('scope:globalconfig');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });

  # ============================================================
  # AUTO-ASSIGN: Assign PR author as assignee
  # ============================================================
  auto-assign-author:
    if: github.event_name == 'pull_request' && github.event.action == 'opened' && github.event.pull_request.user.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Assign PR author
        run: gh pr edit "$PR_URL" --add-assignee "$AUTHOR"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # PROJECT SYNC: Add issues/PRs to project board
  # ============================================================
  project-sync:
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'pull_request' && github.event.action == 'opened')
    runs-on: ubuntu-latest
    outputs:
      item_id: ${{ steps.add.outputs.itemId }}
    steps:
      - name: Add to project
        id: add
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/orgs/lvlup-sw/projects/${{ env.PROJECT_NUMBER }}
          github-token: ${{ secrets.PROJECT_TOKEN }}

  # ============================================================
  # PROJECT FIELDS: Set Priority and Iteration based on labels
  # ============================================================
  project-fields:
    needs: project-sync
    if: needs.project-sync.outputs.item_id
    runs-on: ubuntu-latest
    steps:
      - name: Set project fields
        uses: actions/github-script@v7
        env:
          PROJECT_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ITEM_ID: ${{ needs.project-sync.outputs.item_id }}
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const itemId = process.env.ITEM_ID;
            const content = context.payload.issue || context.payload.pull_request;
            const labels = content.labels?.map(l => l.name) || [];
            const body = (content.body || '').toLowerCase();

            // Get project info
            const projectQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                        ... on ProjectV2IterationField {
                          id
                          name
                          configuration {
                            iterations { id title startDate duration }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const { organization } = await github.graphql(projectQuery, {
              org: 'lvlup-sw',
              number: parseInt(process.env.PROJECT_NUMBER || '3')
            });

            const project = organization.projectV2;
            const fields = project.fields.nodes.filter(f => f.id);

            // Find Priority field and set based on label
            const priorityField = fields.find(f => f.name === 'Priority');
            if (priorityField) {
              let priorityOption;
              if (labels.includes('priority:high')) {
                const isUrgent = /urgent|critical|blocker|p0|asap|emergency/.test(body);
                priorityOption = priorityField.options.find(o =>
                  isUrgent ? o.name === 'P0' : o.name === 'P1'
                );
              } else if (labels.includes('priority:low')) {
                priorityOption = priorityField.options.find(o => o.name === 'P3');
              } else {
                priorityOption = priorityField.options.find(o => o.name === 'P2');
              }

              if (priorityOption) {
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $value }
                    }) { projectV2Item { id } }
                  }
                `, {
                  projectId: project.id,
                  itemId: itemId,
                  fieldId: priorityField.id,
                  value: priorityOption.id
                });
                console.log(`Set Priority to ${priorityOption.name}`);
              }
            }

            // Find Iteration field and assign high priority to current iteration
            const iterField = fields.find(f => f.name === 'Sprint' || f.name === 'Iteration');
            if (iterField?.configuration?.iterations && labels.includes('priority:high')) {
              const now = new Date();
              const currentIter = iterField.configuration.iterations.find(iter => {
                const start = new Date(iter.startDate);
                const end = new Date(start.getTime() + iter.duration * 7 * 24 * 60 * 60 * 1000);
                return now >= start && now < end;
              });

              if (currentIter) {
                await github.graphql(`
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { iterationId: $value }
                    }) { projectV2Item { id } }
                  }
                `, {
                  projectId: project.id,
                  itemId: itemId,
                  fieldId: iterField.id,
                  value: currentIter.id
                });
                console.log(`Assigned to current iteration: ${currentIter.title}`);
              }
            }

  # ============================================================
  # STALE MANAGEMENT: Mark and close inactive issues
  # ============================================================
  stale:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/stale@v9
        with:
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had
            recent activity. It will be closed in 14 days if no further activity occurs.
          close-issue-message: |
            This issue was closed because it has been stale for 14 days with no activity.
            Feel free to reopen if this is still relevant.
          stale-issue-label: 'status:stale'
          exempt-issue-labels: 'priority:high,status:blocked'
          days-before-stale: 60
          days-before-close: 14
          operations-per-run: 30

  # ============================================================
  # PR AUTOMATION: Auto-merge Renovate PRs
  # ============================================================
  auto-merge-renovate:
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'renovate[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge for Renovate PRs
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # RELEASE AUTOMATION: Generate changelog and release
  # ============================================================
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: .github/cliff.toml
          args: --latest --strip header

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.content }}
          generate_release_notes: false
